<!DOCTYPE html>
<html lang="pt">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Horário Automático ISPGAYA</title>
  <style>
    html,
    body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      background: #fff;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: system-ui, sans-serif;
    }

    #openBtn {
      position: absolute;
      bottom: 40px;
      padding: 1rem 2rem;
      font-size: 1.1rem;
      border: none;
      border-radius: 12px;
      background: #0078ff;
      color: #fff;
      cursor: pointer;
      box-shadow: 0 5px 15px rgba(0, 0, 0, .3);
      transition: transform .2s;
      z-index: 2;
    }

    #openBtn:hover {
      transform: scale(1.05);
    }

    #msg {
      position: absolute;
      top: 20px;
      font-size: 1.2rem;
      color: #fff;
      text-align: center;
      z-index: 2;
    }

    iframe,
    #weekendImg {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      z-index: 1;
    }

    iframe {
      border: none;
      display: none;
      background: #fff;
    }

    #weekendImg {
      display: none;
      object-fit: contain;
      background: #d68d37;
    }

    #messagesContainer {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: rgba(0, 0, 0, 0.7);
      color: #fff;
      font-size: 0.85rem;
      padding: 5px;
      box-sizing: border-box;
      max-height: 30%;
      overflow-y: auto;
      flex-direction: column;
      z-index: 3;
      display: none;
    }

    #messagesContainer div {
      white-space: pre-wrap;
      word-break: break-word;
      padding: 1px 8px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.3);
    }
  </style>
</head>

<body>
  <div id="msg">Clique no botão para abrir o horário em ecrã inteiro</div>
  <button id="openBtn">Abrir Horário</button>
  <div id="messagesContainer"></div>
  <iframe id="viewer"></iframe>
  <img id="weekendImg" src="imgs/ispgaya.jpg">
  <script>
    const viewer = document.getElementById("viewer"), msg = document.getElementById("msg"), btn = document.getElementById("openBtn"), messagesContainer = document.getElementById("messagesContainer");

    const jsDayToFileDay = d => d ? d > 6 ? null : d - 1 : null;

    async function getTodayUrl() {
      const fileDay = jsDayToFileDay(new Date().getDay());
      if (fileDay === null) return null;
      try { const res = await fetch(`/latest?day=${fileDay}`); if (!res.ok) return null; const data = await res.json(); return data.url; } catch { return null; }
    }

    async function updateSchedule() {
      viewer.src = ""; const url = await getTodayUrl();
      if (!url) { msg.style.display = "none"; viewer.style.display = "none"; document.getElementById("weekendImg").style.display = "block"; return; }
      document.getElementById("weekendImg").style.display = "none"; msg.style.display = "none"; viewer.src = `/proxy?url=${encodeURIComponent(url)}&r=${Date.now()}`; viewer.style.display = "block";
      viewer.onload = () => {
        const doc = viewer.contentDocument || viewer.contentWindow.document;
        const table = doc.querySelector("table");
        if (!table) return;

        // Remover "Data de impressão"
        new MutationObserver(() => {
          doc.querySelectorAll("p,div").forEach(e => {
            /Data de impressão/i.test(e.textContent) && e.remove();
          });
        }).observe(doc.body, { childList: true, subtree: true });

        // encolher a letra da hora um bocadinho às terças feiras pq a tabela tem muita informação
        const today = new Date().getDay(); // 2 = terça
        if (today === 2) {
          doc.querySelectorAll("td.td_lateral").forEach(td => {
            td.style.fontSize = "9px";     // era 10px
            td.style.lineHeight = "12px";
          });
        }

        scaleToFit();
        window.addEventListener("resize", scaleToFit);
      };
    }

    function openFullscreen() {
      const e = document.documentElement;
      e.requestFullscreen?.() || e.webkitRequestFullscreen?.() || e.msRequestFullscreen?.();
      setTimeout(() => window.dispatchEvent(new Event("resize")), 50);
    }

    function scheduleMidnightUpdate() {
      const now = new Date(), next = new Date(now); next.setHours(24, 0, 5, 0);
      setTimeout(() => { updateSchedule(); scheduleMidnightUpdate(); }, next - now);
    }

    function scheduleAutoRefresh() {
      const target = [10, 14, 18];
      function nextDelay() {
        const now = new Date(), h = now.getHours(), nextH = target.find(x => x > h), trigger = new Date(now);
        if (nextH !== undefined) trigger.setHours(nextH, 0, 0, 0); else { trigger.setDate(trigger.getDate() + 1); trigger.setHours(target[0], 0, 0, 0); }
        return trigger - now;
      }
      (function scheduleNext() {
        setTimeout(async () => {
          const url = await getTodayUrl(); if (url) { viewer.src = `/proxy?url=${encodeURIComponent(url)}&r=${Date.now()}`; setTimeout(() => { viewer.contentDocument?.querySelector("table") && scaleToFit(); }, 150); console.log("Horário recarregado automaticamente:", new Date().toLocaleString()); }
          scheduleNext();
        }, nextDelay());
      })();
    }

    function scaleToFit() {
      const table = viewer.contentDocument?.querySelector("table"); if (!table) return;
      table.style.transform = "none"; table.style.display = "block"; table.style.margin = "0 auto";
      const availableHeight = viewer.clientHeight - messagesContainer.offsetHeight;
      const scaleY = Math.min(availableHeight / table.scrollHeight, 1);
      table.style.transformOrigin = "top left"; table.style.transform = `scaleY(${scaleY})`;
    }

    btn.addEventListener("click", async () => { openFullscreen(); btn.style.display = "none"; messagesContainer.style.display = "flex"; await updateSchedule(); scheduleMidnightUpdate(); scheduleAutoRefresh(); });

    async function loadMessages() {
      try {
        const res = await fetch("http://localhost:3001/public/messages");
        const messages = await res.json();

        messagesContainer.innerHTML = "";

        messages.forEach(msg => {
          const p = document.createElement("div");
          p.textContent = msg.text;
          p.style.padding = "1px 8px";
          p.style.borderBottom = "1px solid rgba(255,255,255,0.3)";
          messagesContainer.appendChild(p);
        });

        // Ajustar tabela para não sobrepor mensagens
        scaleToFit();
      } catch (err) {
        console.error("Erro a carregar mensagens:", err);
      }
    }

    // Atualiza as mensagens a cada 30s
    setInterval(loadMessages, 30000);
    loadMessages();
  </script>
</body>

</html>